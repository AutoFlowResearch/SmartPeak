SmartPeak Features
=============================================================================

Audit trail
-----------------------------------------------------------------------------

Usage
~~~~~

A complete record of all actions and data processing steps invoked by the user is often required in regulated environments.  In addition, for debugging, it is useful to have a record of all actions the software has taken.

SmartPeak records all actions and data processing steps for audit trail and debugging purposes at two levels: 1) an application log :ref:`logs`, and 2) feature log.

**Application log**
The application log records all actions taken by SmartPeak during a user's session.  The log is written to the user's hard drive :ref:`logs` and can also be viewed within the SmartPeak GUI ``view | logs``.  Each action or line-item in the log is groups according to message type (e.g., INFO, DEBUG, WARNING, ERROR, etc.).

**Feature log**
The feature log records all features that were found in a sample along with all changes that were made to each feature during a user's session.  Each feature change is time-stamped so that there is complete provenance of any reported generated by SmartPeak.  In addition, the feature log enables workflow checkpointing whereby a previously saved feature log for a particular sample can be loaded in a later session so that the user does not need to re-run a previously ran workflow for a sample.

Example
~~~~~~~

.. todo::
    Provide an example.

Modify existing or create new data process workflows
-----------------------------------------------------------------------------

Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Creating, saving, and loading sessions
-----------------------------------------------------------------------------


Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Optimize workflow step algorithm parameters
-----------------------------------------------------------------------------

Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Debug feature picking, selection, and filtering (and acquisition methods)
-----------------------------------------------------------------------------

Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Optimize calibration curves and quantitation methods
-----------------------------------------------------------------------------

Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Enable automated QC/QA of workflows
-----------------------------------------------------------------------------

Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Select features from the "best" dilution
-----------------------------------------------------------------------------

Usage
~~~~~

Due to the orders of magnitude difference between different metabolite, lipid, and protein species concentrations in biological samples, one often needs to run the same sample at different concentrations to capture all of the different species within the limits of detection for the instrument.
After processing each of the different sample dilutions (referred to as dilution_factor in SmartPeak), the user often would like to select a specific dilution that a particular component should be reported because that dilution has been found to provide the best signal to noise ratio for that component.

SmartPeak allows to specify this selection as a step of the ``MERGE_INJECTIONS`` workflow step using the ``select_preferred_dilution`` parameter (false by default).

When ``select_preferred_dilution`` is set to true, SmartPeak will look for a file specified by a second parameter ``select_preferred_dilutions_file``. This csv file will conatins the list of components and the corresponding preferred dilution:

.. list-table:: select_dilution.csv
  :header-rows: 1

  * - component_name
    - dilution_factor
  * - trp-L.trp-L_1.Heavy
    - 10
  * - trp-L.trp-L_1.Light
    - 10
  * - arg-L.arg-L_1.Heavy
    - 1
  * - arg-L.arg-L_1.Light
    - 1

During the ``MERGE_INJECTIONS`` all components from the features that are listed in the file and to which the injection dilution does not correspond to the value set in the select_preferred_dilutions_file will be removed. The ``MERGE_INJECTIONS`` will be then applied as usual.

Example
~~~~~~~

Our sequence file is as follow (only relevant columns appear):

.. list-table:: sequence.csv
  :header-rows: 1

  * - sample_name
    - sample_group_name
    - scan_polarity
    - scan_mass_low
    - scan_mass_high
    - dilution_factor
  * - Lyubomir_Split_2_210914_4
    - Group1
    - positive
    - -1
    - -1
    - 10
  * - Lyubomir_Split_2_210914_25
    - Group1
    - negative
    - -1
    - -1
    - 10
  * - Lyubomir_Split_2_210914_5
    - Group1
    - positive
    - -1
    - -1
    - 1
  * - Lyubomir_Split_2_210914_26
    - Group1
    - negative
    - -1
    - -1
    - 10
  * - Lyubomir_Split_2_210914_6
    - Group1
    - positive
    - -1
    - -1
    - 1
  * - Lyubomir_Split_2_210914_6
    - Group1
    - negative
    - -1
    - -1
    - 10

Please note that all our injections we want to select from are in the same group.

The parameters are set as follow in SmartPeak:

.. image:: ../images/select_dilutions_parameters.png

note that the ``mass_range_merge_rule``, ``dilution_series_merge_rule`` and ``scan_polarity_merge_rule`` as been set to Max in our example, but you can set to another value. These rules will be applied after having explcuding the features that do not correspond to our preference.

The dilution file is as follow:

.. list-table:: select_dilution.csv
  :header-rows: 1

  * - component_name
    - dilution_factor
  * - trp-L.trp-L_1.Heavy
    - 10
  * - trp-L.trp-L_1.Light
    - 10
  * - arg-L.arg-L_1.Heavy
    - 1
  * - arg-L.arg-L_1.Light
    - 1

The workflow will be:

.. image:: ../images/select_dilutions_workflow.png

Once the workflow has been run, We will export the Group Pivot Table:

.. image:: ../images/select_dilutions_export.png

The result is then:

.. image:: ../images/select_dilutions_result.png

The value for ``peak_apex_int`` is 207.

Indeed the feature database willl show us that it is the maximum ``peak_apex_int`` from the sample based on dilution 10.

.. image:: ../images/select_dilutions_featuresdb.png

Now, in our dilution file, if we set trp-L.trp-L_1.Heavy to preferred dilution_factor 1, the result will be 137, which is the maximum ``peak_apex_int`` from the sample based on dilution 1.

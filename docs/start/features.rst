SmartPeak Features
=============================================================================

SmartPeak provides a plethora of features for analytical chemistry data processing.  An incomplete set of features are described below.

Audit trail and data provenance
-----------------------------------------------------------------------------

A complete record of all actions and data processing steps invoked by the user is often required in regulated environments.  In addition, for debugging, it is useful to have a record of all actions the software has taken.

SmartPeak records all actions and data processing steps for audit trail and debugging purposes at two levels: 1) an application log, and 2) feature log.

**Application log**
The application log records all actions taken by SmartPeak during a user's session.  
The log is written to the user's hard drive :ref:`logs` and can also be viewed within the SmartPeak GUI ``view | logs``.  
Each action or line-item in the log is groups according to message type (e.g., INFO, DEBUG, WARNING, ERROR, etc.).

**Feature log**
The feature log records all features that were found in a sample along with all changes that were made to each feature during a user's session.  
Each feature change is `time-stamped` so that there is complete provenance of any reported data generated by SmartPeak.  
In addition, the feature log enables workflow checkpointing whereby a previously saved feature log for a particular sample can be loaded in a later session so that the user does not need to re-run a previously ran workflow for a sample.  
Feature logs are recorded during the STORE_FEATURES and can be loaded using the LOAD_FEATURES workflow steps.  
The `used` features can be visualized within the SmartPeak GUI using the various views provided.  
The pyOpenMS python module can be used for further post processing and analysis of features in python (see https://github.com/AutoFlowResearch/BFAIR for examples).

Automated data processing workflows and workflow execution engine
-----------------------------------------------------------------------------

Data procesing workflow presets
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

SmartPeak has been used and optimized for various analytical chemistry workflows.
An example set of optimized workflows have been given presets within SmartPeak for faster selection and execution.
Please see :ref:`tutorials` for in depth walkthroughs for using each of the preset workflows.
The workflow presets are also a good starting point for developing a custom workflow.
Workflow steps can be added or removed using the GUI.

.. todo::
    Workflow modification screen shots.

A complete list of workflow steps and their description can be found in the :ref:`faq`.
Customized workflows can be saved as a ``workflow.csv`` file and loaded into SmartPeak.

Workflow execution engine
~~~~~~~~~~~~~~~~~~~~~~~~~

SmartPeak includes a workflow engine that optimizes the order of workflow step executions and the resources used to process samples in parallel.
Before any workflow is executed, SmartPeak determines which workflow steps can be executed in parallel and which need to be executed in serial by analyzing the workflow step dependencies.
The user has the option to specify the number of resources (i.e., CPU threads) that can be allocated to executing a workflow.
By default, the maximum number of threads available to the user will be used.
Once the order of workflow step executions and resources used to process samples in parallel are optimized, SmartPeak estimates the time needed to complete the workflow.

.. todo::
    Workflow modification screen shots.

The time estimate is continuously updated as the workflow is executed to better reflect operating conditions.

While the number of CPU cores/threads determines the number of samples that can be ran in parallel, it is important to note that the system memory (i.e., RAM) provides an upper limit on the number of samples that can be run during a single workflow.
If you find that workflows are taking a long time, we recommend profiling the system memory to see if your computer is out of memory.
Please see the :ref:`faq` for tips on how to improve system memory utilization for workflows involved large numbers of samples and large data files (e.g., non-targeted metabolomics).


Creating, saving, and loading sessions
-----------------------------------------------------------------------------

Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Optimize workflow step algorithm parameters
-----------------------------------------------------------------------------

Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Debug feature picking, selection, and filtering (and acquisition methods)
-----------------------------------------------------------------------------

Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Optimize calibration curves and quantitation methods
-----------------------------------------------------------------------------

Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Enable automated QC/QA of workflows
-----------------------------------------------------------------------------

Usage
~~~~~

.. todo::
    Describe the usage.

Example
~~~~~~~

.. todo::
    Provide an example.

Select features from the "best" dilution
-----------------------------------------------------------------------------

Usage
~~~~~

Due to the orders of magnitude difference between different metabolite, lipid, and protein species concentrations in biological samples, one often needs to run the same sample at different concentrations to capture all of the different species within the limits of detection for the instrument.
After processing each of the different sample dilutions (referred to as dilution_factor in SmartPeak), the user often would like to select a specific dilution that a particular component should be reported because that dilution has been found to provide the best signal to noise ratio for that component.

SmartPeak allows to specify this selection as a step of the ``MERGE_INJECTIONS`` workflow step using the ``select_preferred_dilution`` parameter (false by default).

When ``select_preferred_dilution`` is set to true, SmartPeak will look for a file specified by a second parameter ``select_preferred_dilutions_file``. This csv file will conatins the list of components and the corresponding preferred dilution:

.. list-table:: select_dilution.csv
  :header-rows: 1

  * - component_name
    - dilution_factor
  * - trp-L.trp-L_1.Heavy
    - 10
  * - trp-L.trp-L_1.Light
    - 10
  * - arg-L.arg-L_1.Heavy
    - 1
  * - arg-L.arg-L_1.Light
    - 1

During the ``MERGE_INJECTIONS`` all components from the features that are listed in the file and to which the injection dilution does not correspond to the value set in the select_preferred_dilutions_file will be removed. The ``MERGE_INJECTIONS`` will be then applied as usual.

Example
~~~~~~~

Our sequence file is as follow (only relevant columns appear):

.. list-table:: sequence.csv
  :header-rows: 1

  * - sample_name
    - sample_group_name
    - scan_polarity
    - scan_mass_low
    - scan_mass_high
    - dilution_factor
  * - Lyubomir_Split_2_210914_4
    - Group1
    - positive
    - -1
    - -1
    - 10
  * - Lyubomir_Split_2_210914_25
    - Group1
    - negative
    - -1
    - -1
    - 10
  * - Lyubomir_Split_2_210914_5
    - Group1
    - positive
    - -1
    - -1
    - 1
  * - Lyubomir_Split_2_210914_26
    - Group1
    - negative
    - -1
    - -1
    - 10
  * - Lyubomir_Split_2_210914_6
    - Group1
    - positive
    - -1
    - -1
    - 1
  * - Lyubomir_Split_2_210914_6
    - Group1
    - negative
    - -1
    - -1
    - 10

Please note that all our injections we want to select from are in the same group.

The parameters are set as follow in SmartPeak:

.. image:: ../images/select_dilutions_parameters.png

note that the ``mass_range_merge_rule``, ``dilution_series_merge_rule`` and ``scan_polarity_merge_rule`` as been set to Max in our example, but you can set to another value. These rules will be applied after having explcuding the features that do not correspond to our preference.

The dilution file is as follow:

.. list-table:: select_dilution.csv
  :header-rows: 1

  * - component_name
    - dilution_factor
  * - trp-L.trp-L_1.Heavy
    - 10
  * - trp-L.trp-L_1.Light
    - 10
  * - arg-L.arg-L_1.Heavy
    - 1
  * - arg-L.arg-L_1.Light
    - 1

The workflow will be:

.. image:: ../images/select_dilutions_workflow.png

Once the workflow has been run, We will export the Group Pivot Table:

.. image:: ../images/select_dilutions_export.png

The result is then:

.. image:: ../images/select_dilutions_result.png

The value for ``peak_apex_int`` is 207.

Indeed the feature database willl show us that it is the maximum ``peak_apex_int`` from the sample based on dilution 10.

.. image:: ../images/select_dilutions_featuresdb.png

Now, in our dilution file, if we set trp-L.trp-L_1.Heavy to preferred dilution_factor 1, the result will be 137, which is the maximum ``peak_apex_int`` from the sample based on dilution 1.
